{"version":3,"sources":["../src/urlForImage.js"],"names":["SPEC_NAME_TO_URL_NAME_MAPPINGS","urlForImage","options","spec","source","image","asset","_ref","crop","left","Math","round","width","top","height","right","bottom","hotSpotVerticalRadius","hotspot","hotSpotHorizontalRadius","hotSpotCenterX","x","hotSpotCenterY","y","rect","focalPoint","ignoreImageParams","fit","specToImageUrl","cdnUrl","baseUrl","filename","id","format","projectId","dataset","params","isEffectiveCrop","push","flipHorizontal","flipVertical","forEach","mapping","specName","param","encodeURIComponent","length","join","result","desiredAspectRatio","cropAspectRatio","hotspotXCenter","hotspotYCenter","max","floor"],"mappings":"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","sourcesContent":["import parseSource from './parseSource'\nimport parseAssetId from './parseAssetId'\n\nconst SPEC_NAME_TO_URL_NAME_MAPPINGS = [\n  ['width', 'w'],\n  ['height', 'h'],\n  ['format', 'fm'],\n  ['download', 'dl'],\n  ['blur', 'blur'],\n  ['sharpen', 'sharp'],\n  ['invert', 'invert'],\n  ['orientation', 'or'],\n  ['minHeight', 'min-h'],\n  ['maxHeight', 'max-h'],\n  ['minWidth', 'min-w'],\n  ['maxWidth', 'max-w'],\n  ['quality', 'q'],\n  ['fit', 'fit'],\n  ['crop', 'crop']\n]\n\nexport default function urlForImage(options) {\n  let spec = {...(options || {})}\n  const source = spec.source\n  delete spec.source\n\n  const image = parseSource(source)\n  if (!image) {\n    return null\n  }\n\n  const asset = parseAssetId(image.asset._ref)\n\n  // Compute crop rect in terms of pixel coordinates in the raw source image\n  const crop = {\n    left: Math.round(image.crop.left * asset.width),\n    top: Math.round(image.crop.top * asset.height)\n  }\n\n  crop.width = Math.round(asset.width - image.crop.right * asset.width - crop.left)\n  crop.height = Math.round(asset.height - image.crop.bottom * asset.height - crop.top)\n\n  // Compute hot spot rect in terms of pixel coordinates\n  const hotSpotVerticalRadius = (image.hotspot.height * asset.height) / 2\n  const hotSpotHorizontalRadius = (image.hotspot.width * asset.width) / 2\n  const hotSpotCenterX = image.hotspot.x * asset.width\n  const hotSpotCenterY = image.hotspot.y * asset.height\n  const hotspot = {\n    left: hotSpotCenterX - hotSpotHorizontalRadius,\n    top: hotSpotCenterY - hotSpotVerticalRadius,\n    right: hotSpotCenterX + hotSpotHorizontalRadius,\n    bottom: hotSpotCenterY + hotSpotHorizontalRadius\n  }\n\n  spec.asset = asset\n\n  // If irrelevant, or if we are requested to: don't perform crop/fit based on\n  // the crop/hotspot.\n  if (!(spec.rect || spec.focalPoint || spec.ignoreImageParams || spec.crop)) {\n    spec = {...spec, ...fit({crop, hotspot}, spec)}\n  }\n\n  return specToImageUrl(spec)\n}\n\n// eslint-disable-next-line complexity\nfunction specToImageUrl(spec) {\n  const cdnUrl = spec.baseUrl || 'https://cdn.sanity.io'\n  const filename = `${spec.asset.id}-${spec.asset.width}x${spec.asset.height}.${spec.asset.format}`\n  const baseUrl = `${cdnUrl}/images/${spec.projectId}/${spec.dataset}/${filename}`\n\n  const params = []\n\n  if (spec.rect) {\n    // Only bother url with a crop if it actually crops anything\n    const isEffectiveCrop =\n      spec.rect.left != 0 ||\n      spec.rect.top != 0 ||\n      spec.rect.height != spec.asset.height ||\n      spec.rect.width != spec.asset.width\n    if (isEffectiveCrop) {\n      params.push(`rect=${spec.rect.left},${spec.rect.top},${spec.rect.width},${spec.rect.height}`)\n    }\n  }\n\n  if (spec.focalPoint) {\n    params.push(`fp-x=${spec.focalPoint.x}`)\n    params.push(`fp-x=${spec.focalPoint.y}`)\n  }\n\n  if (spec.flipHorizontal || spec.flipVertical) {\n    params.push(`flip=${spec.flipHorizontal ? 'h' : ''}${spec.flipVertical ? 'v' : ''}`)\n  }\n\n  // Map from spec name to url param name, and allow using the actual param name as an alternative\n  SPEC_NAME_TO_URL_NAME_MAPPINGS.forEach(mapping => {\n    const [specName, param] = mapping\n    if (typeof spec[specName] !== 'undefined') {\n      params.push(`${param}=${encodeURIComponent(spec[specName])}`)\n    } else if (typeof spec[param] !== 'undefined') {\n      params.push(`${param}=${encodeURIComponent(spec[param])}`)\n    }\n  })\n\n  if (params.length === 0) {\n    return baseUrl\n  }\n\n  return `${baseUrl}?${params.join('&')}`\n}\n\nfunction fit(source, spec) {\n  const result = {\n    width: spec.width,\n    height: spec.height\n  }\n\n  // If we are not constraining the aspect ratio, we'll just use the whole crop\n  if (!(spec.width && spec.height)) {\n    result.rect = source.crop\n    return result\n  }\n\n  const crop = source.crop\n  const hotspot = source.hotspot\n\n  // If we are here, that means aspect ratio is locked and fitting will be a bit harder\n  const desiredAspectRatio = spec.width / spec.height\n  const cropAspectRatio = crop.width / crop.height\n\n  if (cropAspectRatio > desiredAspectRatio) {\n    // The crop is wider than the desired aspect ratio. That means we are cutting from the sides\n    const height = crop.height\n    const width = height * desiredAspectRatio\n    const top = crop.top\n    // Center output horizontally over hotspot\n    const hotspotXCenter = (hotspot.right - hotspot.left) / 2 + hotspot.left\n    let left = hotspotXCenter - width / 2\n    // Keep output within crop\n    if (left < crop.left) {\n      left = crop.left\n    } else if (left + width > crop.left + crop.width) {\n      left = crop.left + crop.width - width\n    }\n    result.rect = {\n      left: Math.round(left),\n      top: Math.round(top),\n      width: Math.round(width),\n      height: Math.round(height)\n    }\n    return result\n  }\n  // The crop is taller than the desired ratio, we are cutting from top and bottom\n  const width = crop.width\n  const height = width / desiredAspectRatio\n  const left = crop.left\n  // Center output vertically over hotspot\n  const hotspotYCenter = (hotspot.bottom - hotspot.top) / 2 + hotspot.top\n  let top = hotspotYCenter - height / 2\n  // Keep output rect within crop\n  if (top < crop.top) {\n    top = crop.top\n  } else if (top + height > crop.top + crop.height) {\n    top = crop.top + crop.height - height\n  }\n  result.rect = {\n    left: Math.max(0, Math.floor(left)),\n    top: Math.max(0, Math.floor(top)),\n    width: Math.round(width),\n    height: Math.round(height)\n  }\n  return result\n}\n\n// For backwards-compatibility\nexport {parseSource}\n"],"file":"urlForImage.js"}